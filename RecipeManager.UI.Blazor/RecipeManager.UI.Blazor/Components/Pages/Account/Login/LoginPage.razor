@page "/login"

@using FluentValidation
@using MudBlazor
@using RecipeManager.Shared.Contracts.User.Registration
@using RecipeManager.UI.Blazor.Components.Extensions
@using RecipeManager.UI.Blazor.Components.Pages.Account
@using RecipeManager.UI.Blazor.Services

@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IdentityApiService IdentityApi

<MudPaper Class="pa-6 mx-auto" MaxWidth="400px">
    <MudForm Model="@loginModel" ValidationDelay="0" @bind-IsValid="@isSubmitEnabled">
        <MudText Typo="Typo.h5" Class="mb-4">Sign in</MudText>

        <MudTextField @bind-Value="loginModel.UserName" Label="Username" For="@(() => loginModel.UserName)" Required=true/>
        <MudTextField @bind-Value="loginModel.Password" Label="Password" For="@(() => loginModel.Password)" InputType="InputType.Password" Required=true />

        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit" Disabled="@(!isSubmitEnabled)" Class="mt-4" FullWidth>
            Sign In
        </MudButton>
        <MudText ReadOnly="true" Color="Color.Error">@errorMessage</MudText>

        <MudGrid AlignItems="AlignItems.Center" Class="mt-6">
            <MudItem xs="12" Class="d-flex justify-space-between align-center mt-4">
                <MudText Typo="Typo.body1">Not a member yet?</MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="NavigateToRegisterPage">
                    Register
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudPaper>

@code {
    private LoginRequest loginModel = new();
    private bool isSubmitEnabled = false;
    private string errorMessage = "";

    private async Task Submit()
    {
        try
        {
            string message = await IdentityApi.SignIn(loginModel);

            if (string.IsNullOrEmpty(message))
            {
                Navigation.NavigateTo("/");
            }

            errorMessage = message;
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred while signing in: {ex.Message}";
        }
    }

    private void NavigateToRegisterPage()
    {
        Navigation.NavigateTo("/register");
    }
}
